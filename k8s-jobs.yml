releases:
- name: cron
  version: latest

instance_groups:
- name: consul
  networks:
    - name: services
      static_ips:
      - (( grab terraform_outputs.kubernetes_static_ips.[0] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[1] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[2] ))

- name: etcd
  networks:
    - name: services
      static_ips:
      - (( grab terraform_outputs.kubernetes_static_ips.[3] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[4] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[5] ))
  jobs:
  - (( append ))
  - name: cron
    release: cron
    properties:
      cron:
        variables:
          AWS_DEFAULT_REGION: (( grab meta.aws.default_region ))
          S3_BUCKET_NAME: (( grab meta.etcd_bucket_name ))
        entries:
        - script:
            name: etcdbackup.sh
            contents: (( file "cronjobs/etcdbackup.sh" ))
          minute: '*/15'
          hour: '*'
          day: '*'
          month: '*'
          wday: '*'
          user: root

- name: master
  networks:
    - name: services
      static_ips:
      - (( grab terraform_outputs.kubernetes_static_ips.[6] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[7] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[8] ))
  jobs:
  - name: docker
    properties:
      docker:
        log_options: [max-size=10m, max-file=1]

- name: minion
  networks:
    - name: services
      static_ips:
      - (( grab terraform_outputs.kubernetes_static_ips.[9] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[10] ))
      - (( grab terraform_outputs.kubernetes_static_ips.[11] ))
  jobs:
  - name: docker
    properties:
      docker:
        log_options: [max-size=10m, max-file=1]

- name: apply-kubernetes-manifests
  jobs:
  - name: apply-kubernetes-manifests
    properties:
      manifests:
      - content: (( file "manifests/storage-class.yaml" ))
      - content: (( file "manifests/kube2iam.yaml" ))
        recreate: true
      - content: (( file "manifests/fluentd-cloudwatch.yaml" ))
        recreate: true
      - content: (( file "manifests/riemann-podstatus.yaml" ))
        recreate: true

update:
  canaries: 0
  max_in_flight: 1
  canary_watch_time: 30000-600000
  update_watch_time: 30000-600000
  serial: true

